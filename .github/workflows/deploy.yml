name: Deploy

on:
  push:
    tags:
      - '*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@master
      - name: Convert *.gmi to *.html
        run: |
          curl -O https://notabug.org/tinyrabbit/gmi2html/raw/master/gmi2html
          chmod +x gmi2html
          for i in **/*.gmi;do
            ./gmi2html "$i" > "${i/\.gmi/.html}"
          done
          rm gmi2html
      - name: Archive html + gmi files into tar
        run: |
          tar zcvf site.tar.gz ./pub
      - name: Upload files
        run: |
          curl -s --oauth2-bearer "${{ secrets.SH_TOKEN }}" \
               -F "content=@site.tar.gz" \
               -F "protocol=GEMINI" \
               "https://pages.sr.ht/publish/${{ secrets.SH_USER }}.srht.site" \
          && echo "published: gemini+https://${{ secrets.SH_USER }}.srht.site"
